<script>
    // Add email submission tracking with improved error handling
    document.addEventListener('DOMContentLoaded', function() {
        // Wait a brief moment to ensure tracking.js is fully loaded
        setTimeout(function() {
            const contactForms = document.querySelectorAll('.contact-form');
            
            contactForms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const emailInput = this.querySelector('input[type="email"]');
                    const email = emailInput.value;
                    const category = this.querySelector('button').getAttribute('data-category');
                    const message = this.querySelector('.form-message');
                    
                    // Skip tracking if in admin mode
                    if (localStorage.getItem('trackingDisabled') === 'true') {
                        message.textContent = "Your information has been submitted!";
                        message.style.color = "#4CAF50";
                        form.reset();
                        
                        setTimeout(() => {
                            message.textContent = "";
                        }, 5000);
                        return;
                    }
                    
                    // Get session data if available
                    let sessionId = 'Unknown';
                    try {
                        const sessionData = JSON.parse(sessionStorage.getItem('sessionTracking') || '{}');
                        sessionId = sessionData.sessionId || 'Unknown';
                    } catch (error) {
                        console.error("Error getting session data:", error);
                    }
                    
                    // First check if window object has trackContactRequest
                    if (typeof window.trackContactRequest === 'function') {
                        // Use the trackContactRequest function
                        const success = window.trackContactRequest(email, category, sessionId);
                        
                        if (success) {
                            // Show success message
                            message.textContent = "Your information has been submitted!";
                            message.style.color = "#4CAF50";
                            form.reset();
                            
                            // Clear the message after a few seconds
                            setTimeout(() => {
                                message.textContent = "";
                            }, 5000);
                        } else {
                            message.textContent = "There was a problem submitting your request. Please try again.";
                            message.style.color = "#FF5252";
                        }
                    } else {
                        // Fallback method if trackContactRequest isn't available
                        console.warn("trackContactRequest function not available, using fallback");
                        
                        // Just show success message and clear form (since tracking is not critical)
                        message.textContent = "Your information has been submitted!";
                        message.style.color = "#4CAF50";
                        form.reset();
                        
                        // Clear the message after a few seconds
                        setTimeout(() => {
                            message.textContent = "";
                        }, 5000);
                        
                        // Log this event for debugging
                        console.error("trackContactRequest function not available");
                    }
                });
            });
        }, 500); // Short delay to ensure scripts are loaded
    });
</script>
